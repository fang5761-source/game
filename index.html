<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹ä¹ä¹˜æ³•å¤§æŒ‘æˆ°</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* UI èª¿æ•´ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            min-height: 98vh; 
            padding-top: 8px; 
        }
        .game-container {
            max-width: 320px; 
            width: 100%;
            background-color: #ffffff;
            box-shadow: 0 6px 15px -2px rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            padding: 12px; 
            margin: 8px; 
        }
        .answer-button {
            transition: all 0.15s ease-in-out;
            transform: scale(1);
        }
        .answer-button:active {
            transform: scale(0.98);
        }
        #feedback-message {
            min-height: 70px; 
            line-height: 1.4;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        @keyframes clap {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.2) rotate(5deg); }
            50% { transform: scale(1) rotate(-5deg); }
            75% { transform: scale(1.2) rotate(5deg); }
        }
        .clap-animation {
            animation: clap 0.5s ease-in-out infinite;
        }
    </style>
</head>
<body>

<div class="game-container text-center">
    <h1 class="text-xl font-extrabold mb-3 text-purple-600">
        ä¹ä¹ä¹˜æ³•å¤§æŒ‘æˆ°
    </h1>
    
    <!-- éŠæˆ²è¨­å®š / é–‹å§‹ç•«é¢ -->
    <div id="setup-screen">
        <!-- æ™‚é–“é¸æ“‡å€å¡Š -->
        <div class="mb-4 p-3 bg-purple-100 rounded-lg shadow-inner">
            <p class="text-xs font-semibold text-purple-700 mb-2">æ¯é¡Œæ™‚é–“é™åˆ¶ (ç§’):</p>
            <div id="time-selector" class="flex justify-center space-x-1">
                <button data-time="1" onclick="setTimeLimit(1)" class="time-btn py-0.5 px-2 text-xs font-bold rounded-full transition duration-150">1 ç§’</button>
                <button data-time="2" onclick="setTimeLimit(2)" class="time-btn py-0.5 px-2 text-xs font-bold rounded-full transition duration-150">2 ç§’</button>
                <button data-time="3" onclick="setTimeLimit(3)" class="time-btn py-0.5 px-2 text-xs font-bold rounded-full transition duration-150">3 ç§’</button>
                <button data-time="5" onclick="setTimeLimit(5)" class="time-btn py-0.5 px-2 text-xs font-bold rounded-full transition duration-150">5 ç§’</button>
            </div>
        </div>
        
        <button id="start-button"
                class="w-full py-3 mb-2 bg-green-500 text-white text-base font-bold rounded-xl hover:bg-green-600 transition duration-150 ease-in-out shadow-lg"
                onclick="startGame()">
            é–‹å§‹æŒ‘æˆ° (å…± 10 é¡Œ)
        </button>
    </div>

    <!-- éŠæˆ²é€²è¡Œç•«é¢ -->
    <div id="game-screen" class="hidden">
        <!-- åˆ†æ•¸/é€²åº¦é¡¯ç¤º -->
        <div class="mb-3 p-1.5 bg-purple-100 rounded-lg shadow-inner">
            <p class="text-xs font-semibold text-purple-700">å›åˆé€²åº¦:</p>
            <span id="score-display" class="text-xl font-black text-purple-900">0/10</span>
        </div>
        
        <!-- æ™‚é–“é™åˆ¶é€²åº¦æ¢ -->
        <div class="w-full h-2 bg-gray-200 rounded-full mb-3 overflow-hidden shadow-inner">
            <div id="timer-bar" 
                 class="h-full bg-green-500 transition-all duration-100 ease-linear" 
                 style="width: 100%;">
            </div>
        </div>

        <!-- å•é¡Œå€å¡Š -->
        <div class="mb-4 p-3 bg-pink-50 rounded-xl border-4 border-pink-200">
            <p id="question" class="text-2xl font-extrabold text-gray-800">
                ? Ã— ? = ?
            </p>
        </div>

        <!-- ç­”æ¡ˆæŒ‰éˆ•å€å¡Š -->
        <div id="answer-buttons" class="grid grid-cols-2 gap-2 mb-3">
            <!-- æŒ‰éˆ•å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>

    <!-- æç¤º/çµæœè¨Šæ¯ (çµæœç¸½çµæœƒé¡¯ç¤ºåœ¨é€™è£¡) -->
    <div id="feedback-message" class="text-sm font-semibold mt-3">
        <!-- è¨Šæ¯/ç¸½çµå°‡ç”± JS å‹•æ…‹æ›´æ–° -->
    </div>
    
    <!-- é‡ç©æŒ‰éˆ• -->
    <button id="reset-button"
            class="hidden w-full py-2 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 transition duration-150 ease-in-out shadow-md mt-3"
            onclick="resetToSetup()">
        å†ç©ä¸€æ¬¡
    </button>
</div>

<script>
    // --- éŠæˆ²è¨­å®šèˆ‡ç‹€æ…‹è®Šæ•¸ ---
    const TOTAL_QUESTIONS_IN_ROUND = 10;
    let correctAnswersInRound = 0; 
    let currentQuestionIndex = 0; 
    let correctAnswer = 0;
    let isGameActive = false; 

    // æ™‚é–“é™åˆ¶ç›¸é—œè®Šæ•¸
    let timerId; 
    let selectedTimeLimit = 2; // é è¨­å€¼ä¿æŒ 2 ç§’
    const TICK_INTERVAL = 100;
    let timeRemaining = selectedTimeLimit; 

    // DOM å…ƒç´ å¼•ç”¨
    const scoreDisplay = document.getElementById('score-display');
    const questionElement = document.getElementById('question');
    const buttonsContainer = document.getElementById('answer-buttons');
    const feedbackElement = document.getElementById('feedback-message');
    const resetButton = document.getElementById('reset-button');
    const timerBar = document.getElementById('timer-bar');
    const timeButtons = document.querySelectorAll('.time-btn');
    const setupScreen = document.getElementById('setup-screen');
    const gameScreen = document.getElementById('game-screen');


    // --- è¼”åŠ©å‡½å¼ ---
    function playSound(isCorrect) {
        if (typeof AudioContext !== 'undefined') {
            const context = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = context.createOscillator();
            const gainNode = context.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(context.destination);

            if (isCorrect) {
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(600, context.currentTime);
                gainNode.gain.setValueAtTime(0.5, context.currentTime);
                oscillator.start();
                oscillator.stop(context.currentTime + 0.1);
            } else {
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(150, context.currentTime);
                gainNode.gain.setValueAtTime(0.4, context.currentTime);
                oscillator.start();
                oscillator.stop(context.currentTime + 0.2);
            }
        }
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // --- éŠæˆ²æµç¨‹æ§åˆ¶ ---

    function setTimeLimit(seconds) {
        // å…è¨±çš„æ™‚é–“é™åˆ¶ç‚º 1, 2, 3, 5 ç§’
        if ([1, 2, 3, 5].includes(seconds)) {
            selectedTimeLimit = seconds;
            timeButtons.forEach(btn => {
                const isSelected = parseInt(btn.getAttribute('data-time')) === seconds;
                if (isSelected) {
                    btn.className = 'time-btn py-0.5 px-2 text-xs font-bold rounded-full transition duration-150 bg-purple-600 text-white shadow-md';
                } else {
                    btn.className = 'time-btn py-0.5 px-2 text-xs font-bold rounded-full transition duration-150 bg-gray-200 text-gray-800 hover:bg-gray-300';
                }
            });
        }
    }

    function timeUp() {
        clearInterval(timerId);
        isGameActive = false;
        
        showCorrectAnswer(null); 
        
        feedbackElement.className = 'text-base font-semibold mt-3 text-red-700';
        feedbackElement.textContent = `â±ï¸ æ™‚é–“åˆ°ï¼æœ¬é¡Œç­”æ¡ˆæ˜¯ ${correctAnswer}ã€‚`;
        playSound(false);

        setTimeout(handleNextState, 1500); 
    }

    function startTimer() {
        if (timerId) clearInterval(timerId);
        
        timeRemaining = selectedTimeLimit;
        timerBar.style.width = '100%';
        timerBar.classList.remove('bg-red-500', 'bg-yellow-500');
        timerBar.classList.add('bg-green-500'); 

        timerId = setInterval(() => {
            timeRemaining -= TICK_INTERVAL / 1000;
            
            if (timeRemaining <= 0) {
                timeUp();
                return;
            }

            const percentage = (timeRemaining / selectedTimeLimit) * 100;
            timerBar.style.width = `${percentage}%`;

            if (percentage < 25) {
                timerBar.classList.remove('bg-yellow-500', 'bg-green-500');
                timerBar.classList.add('bg-red-500'); 
            } else if (percentage < 50) {
                timerBar.classList.remove('bg-red-500', 'bg-green-500');
                timerBar.classList.add('bg-yellow-500'); 
            } else {
                timerBar.classList.remove('bg-red-500', 'bg-yellow-500');
                timerBar.classList.add('bg-green-500'); 
            }
        }, TICK_INTERVAL);
    }
    
    function showCorrectAnswer(selectedButton) {
         document.querySelectorAll('.answer-button').forEach(btn => {
            btn.disabled = true;
            if (parseInt(btn.getAttribute('data-answer')) === correctAnswer) {
                btn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                btn.classList.add('bg-green-400', 'text-gray-800');
            }
            if (selectedButton && btn === selectedButton) {
                 btn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                 btn.classList.add('bg-red-500');
            }
        });
    }

    function checkAnswer(selectedAnswer, buttonElement) {
        if (!isGameActive) return;

        clearInterval(timerId);
        isGameActive = false;

        const isCorrect = selectedAnswer === correctAnswer;

        if (isCorrect) {
            correctAnswersInRound++;
            
            feedbackElement.className = 'text-base font-semibold mt-3 text-green-600';
            feedbackElement.textContent = `âœ… ç­”å°äº†ï¼`;

            buttonElement.className = buttonElement.className.replace('bg-blue-500', 'bg-green-500').replace('hover:bg-blue-600', 'hover:bg-green-500');
            playSound(true);

            setTimeout(handleNextState, 800);
        } else {
            feedbackElement.className = 'text-base font-semibold mt-3 text-red-600';
            feedbackElement.textContent = `âŒ ç­”éŒ¯äº†ï¼`;

            showCorrectAnswer(buttonElement);
            playSound(false);

            setTimeout(handleNextState, 1500);
        }
    }

    function handleNextState() {
        currentQuestionIndex++; 
        
        feedbackElement.textContent = ''; 

        if (currentQuestionIndex < TOTAL_QUESTIONS_IN_ROUND) {
            isGameActive = true;
            generateQuestionContent();
        } else {
            endGameSummary();
        }
    }
    
    function endGameSummary() {
        gameScreen.classList.add('hidden');
        resetButton.classList.remove('hidden');

        const correct = correctAnswersInRound;
        const total = TOTAL_QUESTIONS_IN_ROUND;
        const accuracy = (correct / total) * 100;
        const isPerfect = correct === total;
        
        questionElement.textContent = "æŒ‘æˆ°çµæŸï¼";
        buttonsContainer.innerHTML = "";
        
        let summaryHtml = `
            <p class="text-xl font-black text-purple-800 mb-1">ğŸ‰ å›åˆç¸½çµ ğŸ‰</p>
            <p class="text-sm font-semibold text-gray-700">ç¸½é¡Œæ•¸: ${total} é¡Œ &nbsp;|&nbsp; ç­”å°é¡Œæ•¸: ${correct} é¡Œ</p>
            <p class="text-3xl font-extrabold text-red-600 mt-2">${accuracy.toFixed(0)}%</p>
        `;
        let encouragement;

        if (isPerfect) {
            encouragement = `<div class="text-3xl font-black text-yellow-600 mt-3 clap-animation">ğŸ‘ å®Œç¾å…¨å°ï¼å¤ªæ£’äº†ï¼ ğŸ†</div>`;
        } else {
            encouragement = `<div class="text-xl font-black text-red-600 mt-3">ğŸ’ª æŒ‘æˆ°çµæŸï¼å†æ¥å†å²ï¼ŒåŠ æ²¹ï¼</div>`;
        }

        feedbackElement.className = 'text-center mt-3';
        feedbackElement.innerHTML = summaryHtml + encouragement;
    }

    // --- æ ¸å¿ƒéŠæˆ²åŠŸèƒ½ ---

    function generateQuestionContent() {
        try {
            const num1 = Math.floor(Math.random() * 9) + 1;
            const num2 = Math.floor(Math.random() * 9) + 1;

            correctAnswer = num1 * num2;
            
            questionElement.textContent = `${num1} Ã— ${num2} = ?`;
            scoreDisplay.textContent = `${currentQuestionIndex + 1}/${TOTAL_QUESTIONS_IN_ROUND}`; 

            const options = [correctAnswer];
            const uniqueAnswers = new Set([correctAnswer]);

            while (options.length < 4) {
                let incorrectAnswer;
                
                if (options.length === 1) {
                    const modifier = Math.random() < 0.5 ? 1 : -1;
                    incorrectAnswer = correctAnswer + modifier * (Math.floor(Math.random() * 5) + 1);
                } else if (options.length === 2) {
                    let factorToChange = Math.random() < 0.5 ? num1 : num2;
                    factorToChange += Math.random() < 0.5 ? 1 : -1;
                    factorToChange = Math.max(1, Math.min(9, factorToChange)); 
                    incorrectAnswer = factorToChange * (factorToChange === num1 ? num2 : num1);
                } else {
                    incorrectAnswer = Math.floor(Math.random() * 81) + 1; 
                }

                incorrectAnswer = Math.max(1, Math.min(81, incorrectAnswer));

                if (!uniqueAnswers.has(incorrectAnswer) && Math.abs(incorrectAnswer - correctAnswer) > 1) {
                    uniqueAnswers.add(incorrectAnswer);
                    options.push(incorrectAnswer);
                }
            }

            shuffleArray(options);
            displayOptions(options);

            feedbackElement.classList.remove('clap-animation');
            startTimer();
        } catch (e) {
            console.error("Error generating question content (CRITICAL):", e);
            feedbackElement.className = 'text-base font-semibold mt-3 text-red-700';
            feedbackElement.textContent = `âŒ éŠæˆ²å‡ºéŒ¯ï¼Œè«‹é»æ“Šã€Œå†ç©ä¸€æ¬¡ã€é‡æ–°é–‹å§‹ã€‚`;
            resetButton.classList.remove('hidden');
            clearInterval(timerId);
            isGameActive = false;
        }
    }

    function displayOptions(options) {
        if (!buttonsContainer) return;
        
        buttonsContainer.innerHTML = '';
        options.forEach(option => {
            const button = document.createElement('button');
            button.textContent = option;
            button.className = 'answer-button py-2.5 px-2 bg-blue-500 text-white text-lg font-bold rounded-xl shadow-lg hover:bg-blue-600 transition duration-150 ease-in-out';
            button.setAttribute('data-answer', option);
            button.onclick = () => checkAnswer(option, button);
            buttonsContainer.appendChild(button);
        });
    }

    function startGame() {
        setupScreen.classList.add('hidden');
        gameScreen.classList.remove('hidden');
        resetButton.classList.add('hidden');
        
        correctAnswersInRound = 0;
        currentQuestionIndex = -1;

        feedbackElement.innerHTML = ''; 
        
        handleNextState();
    }

    function resetToSetup() {
        if (timerId) clearInterval(timerId);

        setupScreen.classList.remove('hidden');
        gameScreen.classList.add('hidden');
        resetButton.classList.add('hidden');

        feedbackElement.innerHTML = '';
        feedbackElement.classList.remove('clap-animation');
        
        questionElement.textContent = `? Ã— ? = ?`;
        buttonsContainer.innerHTML = "";
        scoreDisplay.textContent = `0/${TOTAL_QUESTIONS_IN_ROUND}`;
    }

    // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
    window.onload = () => {
        // ç¢ºä¿é è¨­é¸ä¸­ 2 ç§’
        setTimeLimit(2); 
    }
    
    // å°‡æ ¸å¿ƒå‡½å¼æš´éœ²çµ¦å…¨åŸŸç’°å¢ƒ
    window.setTimeLimit = setTimeLimit;
    window.startGame = startGame;
    window.resetToSetup = resetToSetup;
    window.checkAnswer = checkAnswer;
</script>

</body>
</html>